import React, { useState, useEffect } from 'react';
import { motion, AnimatePresence } from 'framer-motion';

/**
 * --- ICON COMPONENT (CUSTOM SVG PATHS) ---
 */
const Icon = ({ name, className = "w-5 h-5", ...props }) => {
  const paths = {
    Plus: <path d="M12 5v14M5 12h14" />,
    Zap: <path d="M13 2 3 14h9l-1 8 10-12h-9l1-8z" />,
    Flame: <path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 0 0 2.5 2.5z" />,
    Clock: <><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14" /></>,
    CheckCircle2: <><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"/><path d="m9 12 2 2 4-4" /></>,
    X: <path d="M18 6 6 18M6 6l12 12" />,
    Bell: <><path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0" /></>,
    ChevronRight: <path d="m9 18 6-6-6-6" />,
    Trophy: <><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6M18 9h1.5a2.5 2.5 0 0 0 0-5H18M4 22h16M10 14.66V17c0 .55.45 1 1 1h2c.55 0 1-.45 1-1v-2.34M12 2v12.66" /></>,
    Calendar: <><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10" /></>,
    BarChart2: <path d="M18 20V10M12 20V4M6 20v-6" />,
    Settings: <><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3" /></>,
    Gift: <><rect width="18" height="14" x="3" y="8" rx="2"/><path d="M12 5a3 3 0 1 0-5.997.125 4 4 0 0 0-2.526 5.77 4 4 0 0 0 5.996-2.258 4 4 0 0 0 5.996 2.258 4 4 0 0 0-2.526-5.77A3 3 0 1 0 12 5"/><path d="M12 8v14M3 12h18"/></>,
    TrendingUp: <><path d="m22 7-8.5 8.5-5-5L2 17"/><path d="M16 7h6v6"/></>,
    Target: <><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></>,
    Award: <><circle cx="12" cy="8" r="7"/><polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"/></>,
    Shield: <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/>
  };

  return (
    <svg
      xmlns="http://www.w3.org/2000/svg"
      viewBox="0 0 24 24"
      fill="none"
      stroke="currentColor"
      strokeWidth="2"
      strokeLinecap="round"
      strokeLinejoin="round"
      className={className}
      {...props}
    >
      {paths[name] || <circle cx="12" cy="12" r="10" />}
    </svg>
  );
};

/**
 * --- DATA & CONSTANTS ---
 */
const MOCK_USER_STATS = {
  total_xp: 12450,
  available_xp: 450,
  current_level: 12,
  current_streak: 8,
  longest_streak: 15,
  tasks_completed: 142,
  total_focus_minutes: 3840,
  rewards_redeemed: 12,
  badges: ['early-bird', 'focused-session', 'streak-master', 'task-crusher']
};

const ALL_BADGES = [
  { id: 'early-bird', label: 'Early Bird', icon: 'Zap', description: 'Complete a task before 7 AM' },
  { id: 'focused-session', label: 'Deep Focus', icon: 'Clock', description: '60+ minutes of focus' },
  { id: 'streak-master', label: 'Consistent', icon: 'Flame', description: 'Maintain a 7-day streak' },
  { id: 'task-crusher', label: 'Crusher', icon: 'Target', description: 'Complete 100 total tasks' },
  { id: 'top-performer', label: 'Elite', icon: 'Trophy', description: 'Reach Level 20' },
  { id: 'reward-seeker', label: 'Achiever', icon: 'Award', description: 'Redeem 10 rewards' },
];

/**
 * --- NAV COMPONENTS ---
 */

const DesktopNav = ({ activeTab, setActiveTab, menuItems, xp }) => {
  return (
    <nav className="sticky top-0 z-50 w-full border-b border-neutral-100 bg-white/80 backdrop-blur-md hidden lg:block">
      <div className="max-w-6xl mx-auto px-6 h-16 flex items-center justify-between">
        <div className="flex items-center gap-2">
          <div className="w-8 h-8 bg-neutral-900 rounded-lg flex items-center justify-center text-white">
            <Icon name="Zap" className="w-4 h-4 fill-white" />
          </div>
          <span className="font-bold text-neutral-900 tracking-tight">FocusFlow</span>
        </div>

        <div className="flex items-center gap-1">
          {menuItems.map((item) => (
            <button
              key={item.id}
              onClick={() => setActiveTab(item.id)}
              className={`px-4 py-2 rounded-full text-sm font-bold capitalize transition-all ${
                activeTab === item.id
                  ? 'bg-neutral-900 text-white'
                  : 'text-neutral-500 hover:bg-neutral-100'
              }`}
            >
              {item.id}
            </button>
          ))}
        </div>

        <div className="flex items-center gap-4">
          <div className="flex items-center gap-1.5 px-3 py-1.5 bg-amber-50 rounded-full border border-amber-100">
            <Icon name="Zap" className="w-3.5 h-3.5 text-amber-500 fill-amber-500" />
            <span className="text-xs font-black text-amber-700">{xp}</span>
          </div>
          <div className="w-8 h-8 rounded-full bg-neutral-100 border border-neutral-200 flex items-center justify-center cursor-pointer hover:bg-neutral-200 transition-colors">
            <Icon name="Bell" className="w-4 h-4 text-neutral-400" />
          </div>
        </div>
      </div>
    </nav>
  );
};

const MobileNav = ({ activeTab, setActiveTab, menuItems }) => {
  return (
    <div className="fixed bottom-0 left-0 right-0 z-50 bg-white/90 backdrop-blur-lg border-t border-neutral-100 p-2 lg:hidden">
      <div className="flex items-center justify-around max-w-md mx-auto">
        {menuItems.map((item) => (
          <button
            key={item.id}
            onClick={() => setActiveTab(item.id)}
            className={`flex flex-col items-center gap-1 p-2 rounded-2xl transition-all ${
              activeTab === item.id ? 'text-neutral-900' : 'text-neutral-400'
            }`}
          >
            <Icon
              name={item.icon}
              className={`w-6 h-6 transition-transform ${activeTab === item.id ? 'scale-110' : ''}`}
            />
            <span className="text-[10px] font-bold uppercase tracking-tighter">
              {item.id}
            </span>
          </button>
        ))}
      </div>
    </div>
  );
};

/**
 * --- PAGE CONTENT COMPONENTS ---
 */

const LevelProgress = ({ totalXP, currentLevel }) => {
  const xpInCurrentLevel = totalXP % 1000;
  const progress = (xpInCurrentLevel / 1000) * 100;
  
  return (
    <div className="bg-white border border-neutral-200 rounded-xl p-6 h-full shadow-sm">
      <div className="flex justify-between items-start mb-4">
        <div>
          <p className="text-xs font-medium text-neutral-400 uppercase tracking-wider">Current Level</p>
          <p className="text-4xl font-semibold text-neutral-900 tracking-tight">{currentLevel}</p>
        </div>
        <div className="p-3 bg-neutral-900 rounded-xl">
          <Icon name="Trophy" className="w-6 h-6 text-white" />
        </div>
      </div>
      
      <div className="space-y-2">
        <div className="flex justify-between text-xs font-medium">
          <span className="text-neutral-500">{xpInCurrentLevel} XP</span>
          <span className="text-neutral-400">Next: {currentLevel + 1} ({1000 - xpInCurrentLevel} to go)</span>
        </div>
        <div className="h-3 bg-neutral-100 rounded-full overflow-hidden border border-neutral-100">
          <motion.div 
            initial={{ width: 0 }}
            animate={{ width: `${progress}%` }}
            transition={{ duration: 1, ease: "easeOut" }}
            className="h-full bg-neutral-900"
          />
        </div>
      </div>
    </div>
  );
};

const BadgeGrid = ({ earnedBadges }) => {
  const [hoveredBadge, setHoveredBadge] = useState(null);

  return (
    <div className="bg-white border border-neutral-200 rounded-xl p-6 shadow-sm">
      <div className="flex justify-between items-center mb-6">
        <h3 className="text-sm font-semibold text-neutral-900">Achievements</h3>
        <span className="text-xs text-neutral-400">{earnedBadges.length} / {ALL_BADGES.length} Unlocked</span>
      </div>
      <div className="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-6 gap-4">
        {ALL_BADGES.map((badge) => {
          const isUnlocked = earnedBadges.includes(badge.id);
          return (
            <div 
              key={badge.id} 
              className="relative flex flex-col items-center gap-2 group"
              onMouseEnter={() => setHoveredBadge(badge.id)}
              onMouseLeave={() => setHoveredBadge(null)}
            >
              <div className={`relative p-4 rounded-2xl transition-all duration-300 ${
                isUnlocked ? `bg-neutral-900 text-white shadow-md` : 'bg-neutral-50 text-neutral-300 border border-neutral-100'
              }`}>
                <Icon name={badge.icon} className="w-6 h-6" />
                {!isUnlocked && <Icon name="Shield" className="absolute -top-1 -right-1 w-4 h-4 text-neutral-400 fill-white" />}
              </div>
              <span className={`text-[10px] font-medium text-center ${isUnlocked ? 'text-neutral-900' : 'text-neutral-400'}`}>
                {badge.label}
              </span>

              <AnimatePresence>
                {hoveredBadge === badge.id && (
                  <motion.div
                    initial={{ opacity: 0, y: 10, scale: 0.95 }}
                    animate={{ opacity: 1, y: 0, scale: 1 }}
                    exit={{ opacity: 0, y: 5, scale: 0.95 }}
                    className="absolute bottom-full mb-3 z-50 w-48 p-3 bg-neutral-900 text-white rounded-lg shadow-xl text-center pointer-events-none"
                  >
                    <p className="text-xs font-bold mb-1">{badge.label}</p>
                    <p className="text-[10px] leading-relaxed text-neutral-300">
                      {badge.description}
                    </p>
                    <div className="absolute -bottom-1 left-1/2 -translate-x-1/2 w-2 h-2 bg-neutral-900 rotate-45" />
                  </motion.div>
                )}
              </AnimatePresence>
            </div>
          );
        })}
      </div>
    </div>
  );
};

/**
 * --- MAIN APP WRAPPER ---
 */
export default function App() {
  const [activeTab, setActiveTab] = useState('progress');
  const [userStats, setUserStats] = useState(MOCK_USER_STATS);
  const [loading, setLoading] = useState(true);

  useEffect(() => {
    setTimeout(() => {
      setLoading(false);
    }, 800);
  }, []);

  const menuItems = [
    { id: 'home', icon: 'Calendar' },
    { id: 'tasks', icon: 'CheckCircle2' },
    { id: 'analytics', icon: 'BarChart2' },
    { id: 'rewards', icon: 'Gift' },
    { id: 'progress', icon: 'TrendingUp' },
    { id: 'settings', icon: 'Settings' }
  ];

  if (loading) {
    return (
      <div className="min-h-screen bg-white flex items-center justify-center">
        <div className="flex flex-col items-center gap-4">
          <div className="w-8 h-8 border-2 border-neutral-100 border-t-neutral-900 rounded-full animate-spin" />
          <p className="text-sm font-medium text-neutral-400">Syncing performance...</p>
        </div>
      </div>
    );
  }

  // --- DERIVED STATS ---
  const totalFocusHours = Math.round((userStats?.total_focus_minutes || 0) / 60);

  const getNextMilestone = (current, milestones) => {
    for (const milestone of milestones) {
      if (current < milestone) return milestone;
    }
    return milestones[milestones.length - 1];
  };

  const milestones = [
    { 
      label: 'Tasks Completed', 
      value: userStats?.tasks_completed || 0, 
      target: getNextMilestone(userStats?.tasks_completed || 0, [10, 50, 100, 250, 500, 1000]),
      icon: 'Target' 
    },
    { 
      label: 'Total XP', 
      value: userStats?.total_xp || 0, 
      target: getNextMilestone(userStats?.total_xp || 0, [1000, 5000, 10000, 25000, 50000, 100000]),
      icon: 'Zap' 
    },
    { 
      label: 'Focus Hours', 
      value: totalFocusHours, 
      target: getNextMilestone(totalFocusHours, [10, 50, 100, 250, 500, 1000]),
      icon: 'Clock' 
    },
    { 
      label: 'Rewards Redeemed', 
      value: userStats?.rewards_redeemed || 0, 
      target: getNextMilestone(userStats?.rewards_redeemed || 0, [5, 10, 25, 50, 100]),
      icon: 'Award' 
    },
  ];

  return (
    <div className="min-h-screen bg-neutral-50 selection:bg-neutral-900 selection:text-white pb-24 lg:pb-0">
      
      {/* NAVIGATIONBAR */}
      <DesktopNav
        activeTab={activeTab}
        setActiveTab={setActiveTab}
        menuItems={menuItems}
        xp={userStats.available_xp}
      />

      <main className="max-w-4xl mx-auto px-4 py-8 md:py-16">
        
        {/* CONDITIONAL CONTENT RENDERING */}
        {activeTab === 'progress' ? (
          <div className="animate-in fade-in slide-in-from-bottom-4 duration-700">
            {/* Header Section */}
            <header className="mb-12">
              <motion.div initial={{ opacity: 0, x: -20 }} animate={{ opacity: 1, x: 0 }}>
                <div className="inline-flex items-center gap-2 px-2.5 py-1 rounded-full bg-neutral-900 text-[10px] font-bold text-white uppercase tracking-widest mb-4">
                  <Icon name="TrendingUp" className="w-3 h-3" />
                  Active Journey
                </div>
                <h1 className="text-3xl md:text-4xl font-semibold text-neutral-900 tracking-tight">
                  Progress
                </h1>
                <p className="text-neutral-500 mt-2 max-w-sm">
                  Visualize your growth, track milestones, and manage your productivity achievements.
                </p>
              </motion.div>
            </header>

            {/* Streak & Level Cards */}
            <div className="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
              <motion.div initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} className="bg-white border border-neutral-200 rounded-xl p-6 shadow-sm group hover:border-neutral-900 transition-colors duration-300">
                <div className="flex items-center gap-5">
                  <div className="p-4 bg-neutral-900 rounded-2xl transition-colors">
                    <Icon name="Flame" className="w-8 h-8 text-white" />
                  </div>
                  <div>
                    <p className="text-xs font-bold text-neutral-400 uppercase tracking-widest mb-1">Current Streak</p>
                    <div className="flex items-baseline gap-2">
                      <p className="text-5xl font-bold text-neutral-900 tracking-tighter">{userStats.current_streak}</p>
                      <p className="text-sm font-medium text-neutral-400">Days</p>
                    </div>
                  </div>
                </div>
                <div className="mt-8 pt-4 border-t border-neutral-100 flex items-center justify-between">
                  <div className="flex flex-col">
                    <span className="text-[10px] uppercase font-bold text-neutral-400 tracking-wider">All-time High</span>
                    <span className="text-sm font-semibold text-neutral-900">{userStats?.longest_streak} days</span>
                  </div>
                  <div className="h-8 w-px bg-neutral-100" />
                  <div className="flex flex-col text-right">
                    <span className="text-[10px] uppercase font-bold text-neutral-400 tracking-wider">Status</span>
                    <span className="text-sm font-semibold text-neutral-900">Active</span>
                  </div>
                </div>
              </motion.div>

              <motion.div initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.1 }}>
                <LevelProgress totalXP={userStats?.total_xp || 0} currentLevel={userStats?.current_level || 1} />
              </motion.div>
            </div>

            {/* Milestones Grid */}
            <motion.div initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.2 }} className="bg-white border border-neutral-200 rounded-xl p-8 mb-8 shadow-sm">
              <div className="flex items-center justify-between mb-8">
                <div>
                  <h3 className="text-lg font-semibold text-neutral-900">Next Milestones</h3>
                  <p className="text-sm text-neutral-500">Track your progress toward upcoming targets</p>
                </div>
              </div>
              <div className="grid grid-cols-1 sm:grid-cols-2 gap-x-12 gap-y-8">
                {milestones.map((milestone, index) => {
                  const progress = Math.min((milestone.value / milestone.target) * 100, 100);
                  return (
                    <div key={index} className="space-y-3">
                      <div className="flex items-center justify-between">
                        <div className="flex items-center gap-3">
                          <div className="w-8 h-8 rounded-lg bg-neutral-50 flex items-center justify-center">
                             <Icon name={milestone.icon} className="w-4 h-4 text-neutral-900" />
                          </div>
                          <span className="text-xs font-bold text-neutral-500 uppercase tracking-wider">{milestone.label}</span>
                        </div>
                        <span className="text-xs font-mono font-medium text-neutral-900">
                          {milestone.value.toLocaleString()} / {milestone.target.toLocaleString()}
                        </span>
                      </div>
                      <div className="relative h-2 bg-neutral-100 rounded-full overflow-hidden border border-neutral-100">
                        <motion.div initial={{ width: 0 }} animate={{ width: `${progress}%` }} transition={{ duration: 1.2, ease: "circOut", delay: 0.5 + (index * 0.1) }} className="absolute inset-y-0 left-0 bg-neutral-900 rounded-full" />
                      </div>
                    </div>
                  );
                })}
              </div>
            </motion.div>

            {/* Achievements Section */}
            <motion.div initial={{ opacity: 0, y: 20 }} animate={{ opacity: 1, y: 0 }} transition={{ delay: 0.3 }}>
              <BadgeGrid earnedBadges={userStats?.badges || []} />
            </motion.div>

            {/* Footer Stats */}
            <footer className="mt-12 text-center border-t border-neutral-100 pt-12">
               <div className="inline-flex items-center justify-center p-4 bg-white border border-neutral-200 rounded-2xl gap-8 shadow-sm">
                  <div className="text-center">
                    <p className="text-[10px] font-bold text-neutral-400 uppercase tracking-widest">Total Focus</p>
                    <p className="text-lg font-bold text-neutral-900">{totalFocusHours}h</p>
                  </div>
                  <div className="h-8 w-px bg-neutral-100" />
                  <div className="text-center">
                    <p className="text-[10px] font-bold text-neutral-400 uppercase tracking-widest">Completed</p>
                    <div className="flex items-center gap-1 justify-center">
                       <Icon name="CheckCircle2" className="w-3 h-3 text-neutral-900" />
                       <p className="text-lg font-bold text-neutral-900">{userStats.tasks_completed}</p>
                    </div>
                  </div>
               </div>
               <p className="mt-6 text-xs text-neutral-400 italic font-medium tracking-tight">"Consistency is the companion of success."</p>
            </footer>
          </div>
        ) : (
          /* Placeholder for other views */
          <div className="bg-white p-12 rounded-3xl border border-neutral-100 text-center animate-in fade-in zoom-in-95 duration-500">
            <h2 className="text-2xl font-bold capitalize">{activeTab} View</h2>
            <p className="text-neutral-500 mt-2">Content for the {activeTab} section would go here.</p>
          </div>
        )}
      </main>

      <MobileNav
        activeTab={activeTab}
        setActiveTab={setActiveTab}
        menuItems={menuItems}
      />
    </div>
  );
}

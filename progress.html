import React, { useMemo } from 'react';
import { motion } from 'framer-motion';
import { base44 } from '@/api/base44Client';
import { useQuery } from '@tanstack/react-query';
import Icon from '@/components/shared/Icon';

const XP_PER_LEVEL = 500;

const ALL_BADGES = [
  { id: 'early-bird', label: 'Early Bird', icon: 'Zap', description: 'Complete a task before 7 AM' },
  { id: 'focused-session', label: 'Deep Focus', icon: 'Clock', description: '60+ minutes of focus' },
  { id: 'streak-master', label: 'Consistent', icon: 'Flame', description: 'Maintain a 7-day streak' },
  { id: 'task-crusher', label: 'Crusher', icon: 'Target', description: 'Complete 100 total tasks' },
  { id: 'top-performer', label: 'Elite', icon: 'Trophy', description: 'Reach Level 20' },
  { id: 'reward-seeker', label: 'Achiever', icon: 'Award', description: 'Redeem 10 rewards' },
  { id: 'night-owl', label: 'Night Owl', icon: 'Clock', description: 'Focus after 11 PM' },
  { id: 'social-butterfly', label: 'Connector', icon: 'Bell', description: 'Interact with 5 friends' },
  { id: 'mega-focus', label: 'Zen Master', icon: 'Zap', description: '4 hours of focus in one day' },
  { id: 'perfect-week', label: 'God Mode', icon: 'Calendar', description: 'Complete all goals for 7 days' },
  { id: 'budget-king', label: 'Thrifty', icon: 'Gift', description: 'Save 5000 XP without spending' },
  { id: 'iron-will', label: 'Unstoppable', icon: 'Shield', description: 'Maintain a 30-day streak' }
];

const MILESTONES = [
  { xp: 100, label: 'First Steps', reward: 'Complete your first task' },
  { xp: 500, label: 'Getting Started', reward: 'Reach Level 2' },
  { xp: 1000, label: 'Momentum', reward: 'Unlock custom rewards' },
  { xp: 2500, label: 'On Fire', reward: 'Reach Level 5' },
  { xp: 5000, label: 'Dedicated', reward: 'Reach Level 10' },
  { xp: 10000, label: 'Legendary', reward: 'Reach Level 20' },
  { xp: 25000, label: 'Master', reward: 'Reach Level 50' },
  { xp: 50000, label: 'Grandmaster', reward: 'Reach Level 100' }
];

export default function Progress() {
  const { data: userProgress } = useQuery({
    queryKey: ['userProgress'],
    queryFn: async () => {
      const progress = await base44.entities.UserProgress.list();
      return progress[0] || {
        total_xp: 0,
        current_level: 1,
        current_streak: 0,
        longest_streak: 0,
        total_tasks_completed: 0,
        total_focus_minutes: 0,
        earned_badges: []
      };
    }
  });

  const { data: rewards = [] } = useQuery({
    queryKey: ['rewards'],
    queryFn: () => base44.entities.Reward.list()
  });

  const xp = userProgress?.total_xp || 0;
  const level = userProgress?.current_level || 1;
  const streak = userProgress?.current_streak || 0;
  const longestStreak = userProgress?.longest_streak || 0;
  const tasksCompleted = userProgress?.total_tasks_completed || 0;
  const focusMinutes = userProgress?.total_focus_minutes || 0;
  const earnedBadges = userProgress?.earned_badges || [];
  const rewardsRedeemed = rewards.filter(r => r.is_unlocked).length;

  const xpProgress = ((xp % XP_PER_LEVEL) / XP_PER_LEVEL) * 100;
  const xpToNextLevel = XP_PER_LEVEL - (xp % XP_PER_LEVEL);

  const badges = useMemo(() => {
    return ALL_BADGES.map(badge => ({
      ...badge,
      unlocked: earnedBadges.includes(badge.id)
    }));
  }, [earnedBadges]);

  const currentMilestone = MILESTONES.find(m => xp < m.xp);
  const completedMilestones = MILESTONES.filter(m => xp >= m.xp);
  const milestoneProgress = currentMilestone 
    ? (xp / currentMilestone.xp) * 100 
    : 100;

  const formatFocusTime = (minutes) => {
    const hours = Math.floor(minutes / 60);
    const mins = minutes % 60;
    if (hours > 0) return `${hours}h ${mins}m`;
    return `${mins}m`;
  };

  return (
    <div className="max-w-4xl mx-auto px-4 py-8 md:py-12">
      {/* Header */}
      <div className="flex items-center justify-between mb-8">
        <div>
          <h1 className="text-3xl font-extrabold tracking-tight">Progress</h1>
          <p className="text-neutral-500 mt-1">Track your journey to mastery.</p>
        </div>
        <div className="p-2 bg-white border border-neutral-100 rounded-full shadow-sm hidden md:flex">
          <Icon name="TrendingUp" className="w-5 h-5 text-neutral-400" />
        </div>
      </div>

      {/* Level Card */}
      <motion.div
        initial={{ opacity: 0, y: 20 }}
        animate={{ opacity: 1, y: 0 }}
        className="bg-neutral-900 text-white p-8 rounded-3xl mb-8 relative overflow-hidden"
      >
        <div className="absolute top-0 right-0 w-64 h-64 bg-amber-400/10 rounded-full blur-3xl -translate-y-1/2 translate-x-1/2" />
        
        <div className="relative flex items-center justify-between mb-6">
          <div>
            <p className="text-neutral-400 text-sm font-medium">Current Level</p>
            <div className="flex items-baseline gap-2 mt-1">
              <span className="text-6xl font-black text-amber-400">{level}</span>
              <span className="text-neutral-500 font-medium">/ âˆž</span>
            </div>
          </div>
          <motion.div
            animate={{ rotate: [0, 10, -10, 0] }}
            transition={{ repeat: Infinity, duration: 4 }}
            className="w-24 h-24 bg-amber-400 rounded-3xl flex items-center justify-center rotate-12 shadow-2xl"
          >
            <Icon name="Trophy" className="w-12 h-12 text-neutral-900" />
          </motion.div>
        </div>

        <div className="relative">
          <div className="flex justify-between items-center mb-2 text-sm">
            <span className="text-neutral-400">Progress to Level {level + 1}</span>
            <span className="font-bold">{xp % XP_PER_LEVEL} / {XP_PER_LEVEL} XP</span>
          </div>
          <div className="w-full h-4 bg-neutral-800 rounded-full overflow-hidden">
            <motion.div
              initial={{ width: 0 }}
              animate={{ width: `${xpProgress}%` }}
              transition={{ duration: 1, delay: 0.3 }}
              className="h-full bg-gradient-to-r from-amber-400 to-amber-500 rounded-full"
            />
          </div>
          <p className="text-neutral-500 text-sm mt-2">{xpToNextLevel} XP to go</p>
        </div>
      </motion.div>

      {/* Stats Grid */}
      <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-8">
        <motion.div
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ delay: 0.1 }}
          className="bg-white border border-neutral-100 p-5 rounded-2xl shadow-sm"
        >
          <div className="p-2 bg-amber-50 rounded-xl w-fit mb-3">
            <Icon name="Zap" className="w-5 h-5 text-amber-500" />
          </div>
          <p className="text-[10px] font-bold text-neutral-400 uppercase tracking-widest">Total XP</p>
          <h4 className="text-2xl font-extrabold text-neutral-900 mt-1">{xp.toLocaleString()}</h4>
        </motion.div>

        <motion.div
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ delay: 0.2 }}
          className="bg-white border border-neutral-100 p-5 rounded-2xl shadow-sm"
        >
          <div className="p-2 bg-orange-50 rounded-xl w-fit mb-3">
            <Icon name="Flame" className="w-5 h-5 text-orange-500" />
          </div>
          <p className="text-[10px] font-bold text-neutral-400 uppercase tracking-widest">Current Streak</p>
          <h4 className="text-2xl font-extrabold text-neutral-900 mt-1">{streak} days</h4>
        </motion.div>

        <motion.div
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ delay: 0.3 }}
          className="bg-white border border-neutral-100 p-5 rounded-2xl shadow-sm"
        >
          <div className="p-2 bg-green-50 rounded-xl w-fit mb-3">
            <Icon name="CheckCircle2" className="w-5 h-5 text-green-500" />
          </div>
          <p className="text-[10px] font-bold text-neutral-400 uppercase tracking-widest">Tasks Done</p>
          <h4 className="text-2xl font-extrabold text-neutral-900 mt-1">{tasksCompleted}</h4>
        </motion.div>

        <motion.div
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ delay: 0.4 }}
          className="bg-white border border-neutral-100 p-5 rounded-2xl shadow-sm"
        >
          <div className="p-2 bg-indigo-50 rounded-xl w-fit mb-3">
            <Icon name="Clock" className="w-5 h-5 text-indigo-500" />
          </div>
          <p className="text-[10px] font-bold text-neutral-400 uppercase tracking-widest">Focus Time</p>
          <h4 className="text-2xl font-extrabold text-neutral-900 mt-1">{formatFocusTime(focusMinutes)}</h4>
        </motion.div>
      </div>

      {/* Milestones */}
      <motion.div
        initial={{ opacity: 0, y: 20 }}
        animate={{ opacity: 1, y: 0 }}
        transition={{ delay: 0.5 }}
        className="bg-white border border-neutral-100 p-6 rounded-2xl shadow-sm mb-8"
      >
        <h3 className="font-bold text-neutral-900 mb-4">Milestones</h3>
        
        {currentMilestone && (
          <div className="mb-6 p-4 bg-amber-50 rounded-xl border border-amber-100">
            <div className="flex items-center justify-between mb-2">
              <span className="font-bold text-amber-900">{currentMilestone.label}</span>
              <span className="text-sm text-amber-700">{xp.toLocaleString()} / {currentMilestone.xp.toLocaleString()} XP</span>
            </div>
            <div className="w-full h-2 bg-amber-200 rounded-full overflow-hidden">
              <div
                className="h-full bg-amber-500 rounded-full transition-all duration-500"
                style={{ width: `${milestoneProgress}%` }}
              />
            </div>
            <p className="text-sm text-amber-700 mt-2">{currentMilestone.reward}</p>
          </div>
        )}

        <div className="grid md:grid-cols-4 gap-3">
          {MILESTONES.map((milestone, i) => {
            const isCompleted = xp >= milestone.xp;
            const isCurrent = currentMilestone?.xp === milestone.xp;
            
            return (
              <div
                key={i}
                className={`p-4 rounded-xl border transition-all ${
                  isCompleted 
                    ? 'bg-green-50 border-green-200' 
                    : isCurrent
                    ? 'bg-amber-50 border-amber-200'
                    : 'bg-neutral-50 border-neutral-100'
                }`}
              >
                <div className="flex items-center gap-2 mb-2">
                  {isCompleted ? (
                    <Icon name="CheckCircle2" className="w-5 h-5 text-green-600" />
                  ) : (
                    <div className="w-5 h-5 rounded-full border-2 border-neutral-300" />
                  )}
                  <span className={`font-bold ${isCompleted ? 'text-green-700' : 'text-neutral-900'}`}>
                    {milestone.label}
                  </span>
                </div>
                <p className="text-xs text-neutral-500">{milestone.xp.toLocaleString()} XP</p>
              </div>
            );
          })}
        </div>
      </motion.div>

      {/* Badges */}
      <motion.div
        initial={{ opacity: 0, y: 20 }}
        animate={{ opacity: 1, y: 0 }}
        transition={{ delay: 0.6 }}
        className="bg-white border border-neutral-100 p-6 rounded-2xl shadow-sm"
      >
        <div className="flex items-center justify-between mb-4">
          <h3 className="font-bold text-neutral-900">Badges</h3>
          <span className="text-sm text-neutral-500">
            {badges.filter(b => b.unlocked).length} / {badges.length} unlocked
          </span>
        </div>
        
        <div className="grid grid-cols-3 md:grid-cols-6 gap-4">
          {badges.map((badge) => (
            <motion.div
              key={badge.id}
              whileHover={{ scale: 1.05 }}
              className={`flex flex-col items-center p-4 rounded-2xl transition-all cursor-pointer ${
                badge.unlocked
                  ? 'bg-neutral-900 text-white'
                  : 'bg-neutral-100 text-neutral-400'
              }`}
            >
              <div className={`p-3 rounded-xl mb-2 ${badge.unlocked ? 'bg-amber-400/20' : 'bg-neutral-200'}`}>
                <Icon name={badge.icon} className={`w-6 h-6 ${badge.unlocked ? 'text-amber-400' : 'text-neutral-400'}`} />
              </div>
              <span className="text-xs font-bold text-center">{badge.label}</span>
              {badge.unlocked ? (
                <Icon name="CheckCircle2" className="w-4 h-4 text-green-400 mt-1" />
              ) : (
                <Icon name="X" className="w-3 h-3 text-neutral-400 mt-1" />
              )}
            </motion.div>
          ))}
        </div>
      </motion.div>

      {/* Records */}
      <motion.div
        initial={{ opacity: 0, y: 20 }}
        animate={{ opacity: 1, y: 0 }}
        transition={{ delay: 0.7 }}
        className="mt-8 grid md:grid-cols-2 gap-4"
      >
        <div className="bg-neutral-900 text-white p-6 rounded-2xl">
          <div className="flex items-center gap-3 mb-2">
            <Icon name="Flame" className="w-6 h-6 text-orange-400" />
            <span className="text-neutral-400 font-medium">Longest Streak</span>
          </div>
          <p className="text-3xl font-extrabold">{longestStreak} days</p>
        </div>
        
        <div className="bg-neutral-900 text-white p-6 rounded-2xl">
          <div className="flex items-center gap-3 mb-2">
            <Icon name="Gift" className="w-6 h-6 text-purple-400" />
            <span className="text-neutral-400 font-medium">Rewards Redeemed</span>
          </div>
          <p className="text-3xl font-extrabold">{rewardsRedeemed}</p>
        </div>
      </motion.div>
    </div>
  );
}

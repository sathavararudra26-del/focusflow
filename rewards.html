import React, { useState, useEffect, useMemo } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import { 
  Plus, 
  Gift, 
  Zap, 
  History, 
  Trash2, 
  X, 
  CheckCircle2, 
  AlertCircle,
  Trophy,
  Coins,
  Bell,
  Calendar,
  BarChart2,
  Settings,
  TrendingUp
} from 'lucide-react';

// --- Icon Component (Extracted logic) ---
const Icon = ({ name, className = "w-5 h-5", ...props }) => {
  const paths = {
    Plus: <path d="M12 5v14M5 12h14" />,
    Zap: <path d="M13 2 3 14h9l-1 8 10-12h-9l1-8z" />,
    Flame: <path d="M8.5 14.5A2.5 2.5 0 0 0 11 12c0-1.38-.5-2-1-3-1.072-2.143-.224-4.054 2-6 .5 2.5 2 4.9 4 6.5 2 1.6 3 3.5 3 5.5a7 7 0 1 1-14 0c0-1.153.433-2.294 1-3a2.5 2.5 0 0 0 2.5 2.5z" />,
    Clock: <><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14" /></>,
    CheckCircle2: <><path d="M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10z"/><path d="m9 12 2 2 4-4" /></>,
    X: <path d="M18 6 6 18M6 6l12 12" />,
    Bell: <><path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0" /></>,
    ChevronRight: <path d="m9 18 6-6-6-6" />,
    Trophy: <><path d="M6 9H4.5a2.5 2.5 0 0 1 0-5H6M18 9h1.5a2.5 2.5 0 0 0 0-5H18M4 22h16M10 14.66V17c0 .55.45 1 1 1h2c.55 0 1-.45 1-1v-2.34M12 2v12.66" /></>,
    Calendar: <><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10" /></>,
    BarChart2: <path d="M18 20V10M12 20V4M6 20v-6" />,
    Settings: <><path d="M12.22 2h-.44a2 2 0 0 0-2 2v.18a2 2 0 0 1-1 1.73l-.43.25a2 2 0 0 1-2 0l-.15-.08a2 2 0 0 0-2.73.73l-.22.38a2 2 0 0 0 .73 2.73l.15.1a2 2 0 0 1 1 1.72v.51a2 2 0 0 1-1 1.74l-.15.09a2 2 0 0 0-.73 2.73l.22.38a2 2 0 0 0 2.73.73l.15-.08a2 2 0 0 1 2 0l.43.25a2 2 0 0 1 1 1.73V20a2 2 0 0 0 2 2h.44a2 2 0 0 0 2-2v-.18a2 2 0 0 1 1-1.73l.43-.25a2 2 0 0 1 2 0l.15.08a2 2 0 0 0 2.73-.73l.22-.39a2 2 0 0 0-.73-2.73l-.15-.08a2 2 0 0 1-1-1.74v-.5a2 2 0 0 1 1-1.74l.15-.09a2 2 0 0 0 .73-2.73l-.22-.38a2 2 0 0 0-2.73-.73l-.15.08a2 2 0 0 1-2 0l-.43-.25a2 2 0 0 1-1-1.73V4a2 2 0 0 0-2-2z"/><circle cx="12" cy="12" r="3" /></>,
    Gift: <><rect width="18" height="14" x="3" y="8" rx="2"/><path d="M12 5a3 3 0 1 0-5.997.125 4 4 0 0 0-2.526 5.77 4 4 0 0 0 5.996-2.258 4 4 0 0 0 5.996 2.258 4 4 0 0 0-2.526-5.77A3 3 0 1 0 12 5"/><path d="M12 8v14M3 12h18"/></>,
    TrendingUp: <><path d="m22 7-8.5 8.5-5-5L2 17"/><path d="M16 7h6v6"/></>
  };

  return (
    <svg
      xmlns="http://www.w3.org/2000/svg"
      viewBox="0 0 24 24"
      fill="none"
      stroke="currentColor"
      strokeWidth="2"
      strokeLinecap="round"
      strokeLinejoin="round"
      className={className}
      {...props}
    >
      {paths[name] || <circle cx="12" cy="12" r="10" />}
    </svg>
  );
};

// --- Desktop Navigation Component ---
const DesktopNav = ({ activeTab, setActiveTab, menuItems, xp }) => {
  return (
    <nav className="sticky top-0 z-50 w-full border-b border-neutral-100 bg-white/80 backdrop-blur-md hidden lg:block">
      <div className="max-w-6xl mx-auto px-6 h-16 flex items-center justify-between">
        <div className="flex items-center gap-2">
          <div className="w-8 h-8 bg-neutral-900 rounded-lg flex items-center justify-center text-white">
            <Icon name="Zap" className="w-4 h-4 fill-white" />
          </div>
          <span className="font-bold text-neutral-900 tracking-tight">FocusFlow</span>
        </div>

        <div className="flex items-center gap-1">
          {menuItems.map((item) => (
            <button
              key={item.id}
              onClick={() => setActiveTab(item.id)}
              className={`px-4 py-2 rounded-full text-sm font-bold capitalize transition-all ${
                activeTab === item.id
                  ? 'bg-neutral-900 text-white'
                  : 'text-neutral-500 hover:bg-neutral-100'
              }`}
            >
              {item.id}
            </button>
          ))}
        </div>

        <div className="flex items-center gap-4">
          <div className="flex items-center gap-1.5 px-3 py-1.5 bg-amber-50 rounded-full border border-amber-100">
            <Icon name="Zap" className="w-3.5 h-3.5 text-amber-500 fill-amber-500" />
            <span className="text-xs font-black text-amber-700">{xp}</span>
          </div>
          <div className="w-8 h-8 rounded-full bg-neutral-100 border border-neutral-200 flex items-center justify-center cursor-pointer hover:bg-neutral-200 transition-colors">
            <Icon name="Bell" className="w-4 h-4 text-neutral-400" />
          </div>
        </div>
      </div>
    </nav>
  );
};

// --- Mobile Navigation Component ---
const MobileNav = ({ activeTab, setActiveTab, menuItems }) => {
  return (
    <div className="fixed bottom-0 left-0 right-0 z-50 bg-white/90 backdrop-blur-lg border-t border-neutral-100 p-2 lg:hidden">
      <div className="flex items-center justify-around max-w-md mx-auto">
        {menuItems.map((item) => (
          <button
            key={item.id}
            onClick={() => setActiveTab(item.id)}
            className={`flex flex-col items-center gap-1 p-2 rounded-2xl transition-all ${
              activeTab === item.id ? 'text-neutral-900' : 'text-neutral-400'
            }`}
          >
            <Icon
              name={item.icon}
              className={`w-6 h-6 transition-transform ${activeTab === item.id ? 'scale-110' : ''}`}
            />
            <span className="text-[10px] font-bold uppercase tracking-tighter">
              {item.id}
            </span>
          </button>
        ))}
      </div>
    </div>
  );
};

// --- Rewards UI Components ---

const Button = ({ children, className = "", variant = "primary", ...props }) => {
  const variants = {
    primary: "bg-neutral-900 text-white hover:bg-neutral-800",
    outline: "border border-neutral-200 bg-transparent hover:bg-neutral-50 text-neutral-700",
    ghost: "bg-transparent hover:bg-neutral-100 text-neutral-600",
    danger: "bg-red-600 text-white hover:bg-red-700",
    link: "text-neutral-600 underline-offset-4 hover:underline p-0 h-auto"
  };
  const base = "inline-flex items-center justify-center rounded-lg px-4 py-2 text-sm font-medium transition-colors disabled:opacity-50 disabled:pointer-events-none";
  return (
    <button className={`${base} ${variants[variant]} ${className}`} {...props}>
      {children}
    </button>
  );
};

const Card = ({ children, className = "" }) => (
  <div className={`bg-white border border-neutral-200 rounded-xl overflow-hidden shadow-sm ${className}`}>
    {children}
  </div>
);

const RewardForm = ({ onSave, onCancel }) => {
  const [title, setTitle] = useState('');
  const [xpCost, setXpCost] = useState('');

  const handleSubmit = (e) => {
    e.preventDefault();
    if (!title || !xpCost) return;
    onSave({ title, xp_cost: parseInt(xpCost) });
    setTitle('');
    setXpCost('');
  };

  return (
    <Card className="p-6 bg-white border-2 border-dashed border-neutral-200">
      <form onSubmit={handleSubmit} className="space-y-4">
        <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div className="space-y-2">
            <label className="text-sm font-medium text-neutral-700">Reward Name</label>
            <input
              type="text"
              placeholder="e.g. 15 min Break"
              className="w-full px-3 py-2 border border-neutral-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-neutral-900/5"
              value={title}
              onChange={(e) => setTitle(e.target.value)}
              required
            />
          </div>
          <div className="space-y-2">
            <label className="text-sm font-medium text-neutral-700">XP Cost</label>
            <div className="relative">
              <Zap className="absolute left-3 top-2.5 w-4 h-4 text-neutral-400" />
              <input
                type="number"
                placeholder="500"
                className="w-full pl-9 pr-3 py-2 border border-neutral-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-neutral-900/5"
                value={xpCost}
                onChange={(e) => setXpCost(e.target.value)}
                required
              />
            </div>
          </div>
        </div>
        <div className="flex justify-end gap-2 pt-2">
          <Button type="button" variant="ghost" onClick={onCancel}>Cancel</Button>
          <Button type="submit">Create Reward</Button>
        </div>
      </form>
    </Card>
  );
};

const RewardCard = ({ reward, availableXP, onRedeem, onDelete }) => {
  const canAfford = availableXP >= reward.xp_cost;
  
  return (
    <Card className={`relative group transition-all ${reward.is_unlocked ? 'opacity-75 bg-neutral-50' : 'hover:border-neutral-300'}`}>
      <div className="p-5 flex items-start gap-4">
        <div className={`p-3 rounded-xl ${reward.is_unlocked ? 'bg-neutral-200 text-neutral-500' : 'bg-neutral-100 text-neutral-900'}`}>
          <Gift className="w-6 h-6" />
        </div>
        <div className="flex-1 min-w-0">
          <h3 className="font-semibold text-neutral-900 truncate">{reward.title}</h3>
          <div className="flex items-center gap-1.5 mt-1">
            <Zap className={`w-3.5 h-3.5 ${reward.is_unlocked ? 'text-neutral-400' : 'text-neutral-500'}`} />
            <span className="text-sm font-medium text-neutral-500">
              {reward.xp_cost} XP
            </span>
          </div>
        </div>
      </div>
      
      <div className="px-5 pb-5 flex gap-2">
        {!reward.is_unlocked ? (
          <Button 
            className="w-full" 
            disabled={!canAfford}
            onClick={() => onRedeem(reward)}
            variant={canAfford ? 'primary' : 'outline'}
          >
            {canAfford ? 'Redeem Reward' : 'Not enough XP'}
          </Button>
        ) : (
          <div className="w-full py-2 flex items-center justify-center gap-2 text-neutral-500 text-sm font-medium bg-neutral-100 rounded-lg">
            <CheckCircle2 className="w-4 h-4" />
            Claimed
          </div>
        )}
      </div>

      {!reward.is_unlocked && (
        <button
          onClick={() => onDelete(reward)}
          className="absolute right-3 top-3 p-2 opacity-0 group-hover:opacity-100 hover:bg-red-50 rounded-lg transition-all"
        >
          <Trash2 className="w-4 h-4 text-red-400" />
        </button>
      )}
    </Card>
  );
};

// --- Main Application ---

export default function App() {
  const [activeTab, setActiveTab] = useState('rewards');
  const [userStats, setUserStats] = useState({ available_xp: 2450, rewards_redeemed: 1 });
  const [rewards, setRewards] = useState([
    { id: '1', title: 'Coffee Break', xp_cost: 200, is_unlocked: false, created_at: Date.now() },
    { id: '2', title: 'Early Finish', xp_cost: 1500, is_unlocked: false, created_at: Date.now() - 1000 },
    { id: '3', title: 'Sticker Pack', xp_cost: 100, is_unlocked: true, unlocked_at: new Date().toISOString(), created_at: Date.now() - 2000 },
  ]);

  const [showRewardForm, setShowRewardForm] = useState(false);
  const [filter, setFilter] = useState('available');
  const [deleteReward, setDeleteReward] = useState(null);
  const [redeemSuccess, setRedeemSuccess] = useState(null);

  const menuItems = [
    { id: 'home', icon: 'Calendar' },
    { id: 'tasks', icon: 'CheckCircle2' },
    { id: 'analytics', icon: 'BarChart2' },
    { id: 'rewards', icon: 'Gift' },
    { id: 'progress', icon: 'TrendingUp' },
    { id: 'settings', icon: 'Settings' }
  ];

  const availableRewards = useMemo(() => rewards.filter(r => !r.is_unlocked), [rewards]);
  const redeemedRewards = useMemo(() => rewards.filter(r => r.is_unlocked), [rewards]);
  const displayedRewards = filter === 'available' ? availableRewards : redeemedRewards;

  const handleCreate = (data) => {
    const newReward = {
      ...data,
      id: Math.random().toString(36).substr(2, 9),
      is_unlocked: false,
      created_at: Date.now()
    };
    setRewards([newReward, ...rewards]);
    setShowRewardForm(false);
  };

  const handleRedeem = (reward) => {
    if (userStats.available_xp < reward.xp_cost) return;
    setRewards(prev => prev.map(r => r.id === reward.id ? { ...r, is_unlocked: true, unlocked_at: new Date().toISOString() } : r));
    setUserStats(prev => ({ available_xp: prev.available_xp - reward.xp_cost, rewards_redeemed: prev.rewards_redeemed + 1 }));
    setRedeemSuccess(reward);
  };

  const handleDelete = (id) => {
    setRewards(prev => prev.filter(r => r.id !== id));
    setDeleteReward(null);
  };

  return (
    <div className="min-h-screen bg-neutral-50 pb-20 lg:pb-0">
      <DesktopNav 
        activeTab={activeTab} 
        setActiveTab={setActiveTab} 
        menuItems={menuItems} 
        xp={userStats.available_xp} 
      />

      <main className="max-w-4xl mx-auto px-4 py-8 md:py-12">
        {activeTab === 'rewards' ? (
          <motion.div initial={{ opacity: 0 }} animate={{ opacity: 1 }}>
            {/* Page Header */}
            <div className="flex flex-col md:flex-row md:items-center justify-between gap-4 mb-8">
              <div>
                <h1 className="text-3xl font-bold tracking-tight">Rewards Shop</h1>
                <p className="text-neutral-500 text-sm mt-1">Use your hard-earned XP to unlock perks.</p>
              </div>
              <Button onClick={() => setShowRewardForm(true)} className="shadow-sm">
                <Plus className="w-4 h-4 mr-2" />
                New Reward
              </Button>
            </div>

            {/* Sub-Filters */}
            <div className="mb-8 flex items-center border-b border-neutral-200">
              <div className="flex gap-8">
                {['available', 'redeemed'].map((f) => (
                  <button 
                    key={f}
                    onClick={() => setFilter(f)}
                    className={`pb-3 text-sm font-bold capitalize transition-all relative ${filter === f ? 'text-neutral-900' : 'text-neutral-400 hover:text-neutral-600'}`}
                  >
                    {f} ({f === 'available' ? availableRewards.length : redeemedRewards.length})
                    {filter === f && <motion.div layoutId="subtab" className="absolute bottom-0 left-0 right-0 h-0.5 bg-neutral-900" />}
                  </button>
                ))}
              </div>
            </div>

            <AnimatePresence>
              {showRewardForm && (
                <motion.div initial={{ opacity: 0, y: -10 }} animate={{ opacity: 1, y: 0 }} exit={{ opacity: 0, scale: 0.95 }} className="mb-8">
                  <RewardForm onSave={handleCreate} onCancel={() => setShowRewardForm(false)} />
                </motion.div>
              )}
            </AnimatePresence>

            <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
              <AnimatePresence mode="popLayout">
                {displayedRewards.map((reward) => (
                  <motion.div key={reward.id} layout initial={{ opacity: 0, scale: 0.9 }} animate={{ opacity: 1, scale: 1 }} exit={{ opacity: 0, scale: 0.9 }}>
                    <RewardCard reward={reward} availableXP={userStats.available_xp} onRedeem={handleRedeem} onDelete={setDeleteReward} />
                  </motion.div>
                ))}
              </AnimatePresence>
            </div>

            {displayedRewards.length === 0 && (
              <div className="text-center py-20 bg-white rounded-3xl border border-neutral-100">
                <Gift className="w-12 h-12 text-neutral-200 mx-auto mb-4" />
                <h3 className="text-lg font-bold">No rewards found</h3>
                <p className="text-neutral-400 text-sm">Try changing filters or create a new one.</p>
              </div>
            )}
          </motion.div>
        ) : (
          <div className="bg-white p-20 rounded-3xl border border-neutral-100 text-center">
            <Icon name={menuItems.find(i => i.id === activeTab)?.icon} className="w-12 h-12 text-neutral-200 mx-auto mb-4" />
            <h2 className="text-2xl font-bold capitalize">{activeTab} View</h2>
            <p className="text-neutral-500 mt-2">The {activeTab} dashboard features are coming soon!</p>
          </div>
        )}
      </main>

      <MobileNav activeTab={activeTab} setActiveTab={setActiveTab} menuItems={menuItems} />

      {/* Modals */}
      <AnimatePresence>
        {deleteReward && (
          <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-black/40 backdrop-blur-sm">
            <motion.div initial={{ opacity: 0, scale: 0.95 }} animate={{ opacity: 1, scale: 1 }} className="bg-white rounded-2xl p-6 w-full max-w-md shadow-xl">
              <h3 className="text-xl font-bold">Delete Reward?</h3>
              <p className="text-neutral-500 mt-2">Permanently remove "{deleteReward.title}"?</p>
              <div className="flex justify-end gap-3 mt-8">
                <Button variant="ghost" onClick={() => setDeleteReward(null)}>Cancel</Button>
                <Button variant="danger" onClick={() => handleDelete(deleteReward.id)}>Delete</Button>
              </div>
            </motion.div>
          </div>
        )}
      </AnimatePresence>

      <AnimatePresence>
        {redeemSuccess && (
          <div className="fixed inset-0 z-[60] flex items-center justify-center p-4 bg-neutral-900/60 backdrop-blur-md">
            <motion.div initial={{ y: 50, opacity: 0 }} animate={{ y: 0, opacity: 1 }} className="bg-white rounded-3xl p-8 w-full max-w-sm text-center shadow-2xl">
              <div className="w-20 h-20 bg-green-50 rounded-full flex items-center justify-center mx-auto mb-6">
                <Trophy className="w-10 h-10 text-green-600" />
              </div>
              <h2 className="text-2xl font-bold">Success!</h2>
              <p className="text-neutral-600 mt-2 mb-8">"{redeemSuccess.title}" has been unlocked.</p>
              <Button className="w-full" onClick={() => setRedeemSuccess(null)}>Got it</Button>
            </motion.div>
          </div>
        )}
      </AnimatePresence>
    </div>
  );
}

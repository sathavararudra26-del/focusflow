<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FocusFlow | Task Management</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- React and Babel -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <!-- Framer Motion -->
    <script src="https://unpkg.com/framer-motion@10.16.4/dist/framer-motion.js"></script>
    <!-- Firebase SDKs -->
    <script src="https://www.gstatic.com/firebasejs/11.1.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.1.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/11.1.0/firebase-firestore-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; }
        /* Hide scrollbar for Chrome, Safari and Opera */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        /* Hide scrollbar for IE, Edge and Firefox */
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
    </style>
</head>
<body class="bg-neutral-50 text-neutral-900">
<div id="root"></div>

<script type="text/babel">
    const { useState, useEffect, useMemo, forwardRef } = React;
    const { motion, AnimatePresence } = window.Motion;

    // --- Firebase Config & Global Helpers ---
    const firebaseConfig = JSON.parse(__firebase_config);
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'focusflow-default';

    // --- SVG Icons (Lucide-like) ---
    const Icons = {
        Plus: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M12 5v14M5 12h14"/></svg>,
        Zap: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M13 2 3 14h9l-1 8 10-12h-9l1-8z"/></svg>,
        CheckCircle2: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><path d="m9 12 2 2 4-4"/></svg>,
        Circle: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/></svg>,
        Trash2: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 6h18M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2M10 11v6M14 11v6"/></svg>,
        Clock: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>,
        Calendar: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="18" height="18" x="3" y="4" rx="2" ry="2"/><line x1="16" x2="16" y1="2" y2="6"/><line x1="8" x2="8" y1="2" y2="6"/><line x1="3" x2="21" y1="10" y2="10"/></svg>,
        BarChart2: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 20V10M12 20V4M6 20v-6"/></svg>,
        Gift: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect width="18" height="14" x="3" y="8" rx="2"/><path d="M12 5a3 3 0 1 0-5.997.125 4 4 0 0 0-2.526 5.77 4 4 0 0 0 5.996-2.258 4 4 0 0 0 5.996 2.258 4 4 0 0 0-2.526-5.77A3 3 0 1 0 12 5"/><path d="M12 8v14M3 12h18"/></svg>,
        TrendingUp: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m22 7-8.5 8.5-5-5L2 17"/><path d="M16 7h6v6"/></svg>,
        Settings: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>,
        Bell: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M6 8a6 6 0 0 1 12 0c0 7 3 9 3 9H3s3-2 3-9"/><path d="M10.3 21a1.94 1.94 0 0 0 3.4 0"/></svg>,
        X: (props) => <svg {...props} xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M18 6 6 18M6 6l12 12"/></svg>
    };

    // --- Components ---

    const TaskCard = forwardRef(({ task, onComplete, onEdit, onDelete }, ref) => {
        const isCompleted = task.status === 'completed';
        return (
            <div ref={ref} className="w-full">
                <motion.div
                    layout
                    initial={{ opacity: 0, y: 10 }}
                    animate={{ opacity: 1, y: 0 }}
                    exit={{ opacity: 0, scale: 0.95 }}
                    className={`group relative flex items-center p-4 bg-white border border-neutral-200 rounded-2xl shadow-sm transition-all hover:border-neutral-300 ${isCompleted ? 'opacity-70' : ''}`}
                >
                    <button
                        onClick={() => onComplete(task)}
                        className={`mr-4 transition-colors ${isCompleted ? 'text-emerald-500' : 'text-neutral-300 hover:text-neutral-400'}`}
                    >
                        {isCompleted ? <Icons.CheckCircle2 className="w-6 h-6" /> : <Icons.Circle className="w-6 h-6" />}
                    </button>
                    <div className="flex-1 min-w-0 cursor-pointer" onClick={() => onEdit(task)}>
                        <h4 className={`text-sm font-bold truncate ${isCompleted ? 'line-through text-neutral-400' : 'text-neutral-900'}`}>
                            {task.title}
                        </h4>
                        <div className="flex items-center gap-3 mt-1 text-[10px] text-neutral-400 font-bold uppercase tracking-wider">
                            <span className="flex items-center gap-1"><Icons.Clock className="w-3 h-3" /> {task.duration || 15}m</span>
                            <span className="text-amber-600">+{task.xp_value || 10} XP</span>
                        </div>
                    </div>
                    <button
                        onClick={() => onDelete(task)}
                        className="p-2 opacity-0 group-hover:opacity-100 transition-opacity hover:bg-red-50 text-neutral-300 hover:text-red-500 rounded-lg"
                    >
                        <Icons.Trash2 className="w-4 h-4" />
                    </button>
                </motion.div>
            </div>
        );
    });
    TaskCard.displayName = 'TaskCard';

    const TaskForm = ({ task, onSave, onCancel }) => {
        const [title, setTitle] = useState(task?.title || '');
        const [duration, setDuration] = useState(task?.duration || 15);
        const [xp, setXp] = useState(task?.xp_value || 10);
        const [date, setDate] = useState(task?.scheduled_date || new Date().toISOString().split('T')[0]);

        const handleSubmit = (e) => {
            e.preventDefault();
            if (!title.trim()) return;
            onSave({ title, duration: Number(duration), xp_value: Number(xp), scheduled_date: date, status: task?.status || 'pending' });
        };

        return (
            <div className="bg-white border border-neutral-100 rounded-3xl p-6 shadow-xl mb-8">
                <form onSubmit={handleSubmit} className="space-y-4">
                    <div>
                        <label className="block text-[10px] font-black text-neutral-400 uppercase tracking-widest mb-1.5 ml-1">Task Description</label>
                        <input
                            autoFocus
                            className="w-full px-4 py-3 bg-neutral-50 border border-neutral-100 rounded-2xl focus:outline-none focus:ring-2 focus:ring-neutral-900 transition-all font-medium"
                            placeholder="What's the focus?"
                            value={title}
                            onChange={(e) => setTitle(e.target.value)}
                        />
                    </div>
                    <div className="grid grid-cols-3 gap-4">
                        <div>
                            <label className="block text-[10px] font-black text-neutral-400 uppercase tracking-widest mb-1.5 ml-1">Date</label>
                            <input type="date" className="w-full px-4 py-3 bg-neutral-50 border border-neutral-100 rounded-2xl text-sm outline-none" value={date} onChange={(e) => setDate(e.target.value)} />
                        </div>
                        <div>
                            <label className="block text-[10px] font-black text-neutral-400 uppercase tracking-widest mb-1.5 ml-1">Mins</label>
                            <input type="number" className="w-full px-4 py-3 bg-neutral-50 border border-neutral-100 rounded-2xl text-sm outline-none" value={duration} onChange={(e) => setDuration(e.target.value)} />
                        </div>
                        <div>
                            <label className="block text-[10px] font-black text-neutral-400 uppercase tracking-widest mb-1.5 ml-1">XP</label>
                            <input type="number" className="w-full px-4 py-3 bg-neutral-50 border border-neutral-100 rounded-2xl text-sm outline-none" value={xp} onChange={(e) => setXp(e.target.value)} />
                        </div>
                    </div>
                    <div className="flex gap-2 pt-2">
                        <button type="submit" className="flex-1 py-4 bg-neutral-900 text-white font-bold rounded-2xl hover:bg-neutral-800 shadow-lg shadow-neutral-200 transition-all">
                            {task ? 'Update Focus' : 'Schedule Focus'}
                        </button>
                        <button type="button" onClick={onCancel} className="px-6 py-4 border border-neutral-200 text-neutral-600 font-bold rounded-2xl hover:bg-neutral-50">
                            Cancel
                        </button>
                    </div>
                </form>
            </div>
        );
    };

    const PlaceholderView = ({ title, description, icon: IconComponent }) => (
        <div className="py-20 text-center">
            <div className="w-24 h-24 bg-neutral-100 rounded-[2rem] flex items-center justify-center mx-auto mb-6 text-neutral-300">
                <IconComponent className="w-10 h-10" />
            </div>
            <h1 className="text-3xl font-black text-neutral-900 mb-2">{title}</h1>
            <p className="text-neutral-500 max-w-xs mx-auto font-medium">{description}</p>
        </div>
    );

    // --- Main App ---

    const App = () => {
        const [user, setUser] = useState(null);
        const [tasks, setTasks] = useState([]);
        const [activeTab, setActiveTab] = useState('home');
        const [showForm, setShowForm] = useState(false);
        const [editingTask, setEditingTask] = useState(null);
        const [deleteConf, setDeleteConf] = useState(null);

        const menuItems = [
            { id: 'home', icon: Icons.Calendar, label: 'Flow' },
            { id: 'tasks', icon: Icons.CheckCircle2, label: 'Tasks' },
            { id: 'analytics', icon: Icons.BarChart2, label: 'Stats' },
            { id: 'rewards', icon: Icons.Gift, label: 'Prizes' },
            { id: 'progress', icon: Icons.TrendingUp, label: 'Level' },
            { id: 'settings', icon: Icons.Settings, label: 'App' }
        ];

        const totalXP = useMemo(() => {
            return tasks.filter(t => t.status === 'completed').reduce((acc, t) => acc + (t.xp_value || 0), 0);
        }, [tasks]);

        useEffect(() => {
            const initAuth = async () => {
                if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                    await auth.signInWithCustomToken(__initial_auth_token);
                } else {
                    await auth.signInAnonymously();
                }
            };
            initAuth();
            return auth.onAuthStateChanged(setUser);
        }, []);

        useEffect(() => {
            if (!user) return;
            const tasksRef = db.collection('artifacts').doc(appId).collection('users').doc(user.uid).collection('tasks');
            return tasksRef.onSnapshot(snap => {
                const list = snap.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                setTasks(list);
            });
        }, [user]);

        const handleSave = async (data) => {
            const ref = db.collection('artifacts').doc(appId).collection('users').doc(user.uid).collection('tasks');
            if (editingTask) {
                await ref.doc(editingTask.id).update(data);
            } else {
                await ref.add({ ...data, created_at: new Date().toISOString() });
            }
            setShowForm(false);
            setEditingTask(null);
        };

        const toggleStatus = async (task) => {
            const ref = db.collection('artifacts').doc(appId).collection('users').doc(user.uid).collection('tasks').doc(task.id);
            await ref.update({ status: task.status === 'completed' ? 'pending' : 'completed' });
        };

        const deleteTask = async () => {
            if (!deleteConf) return;
            await db.collection('artifacts').doc(appId).collection('users').doc(user.uid).collection('tasks').doc(deleteConf.id).delete();
            setDeleteConf(null);
        };

        const groupedTasks = useMemo(() => {
            const groups = {};
            tasks.forEach(t => {
                const d = t.scheduled_date || 'Future';
                if (!groups[d]) groups[d] = [];
                groups[d].push(t);
            });
            return Object.keys(groups).sort().map(d => ({ date: d, items: groups[d] }));
        }, [tasks]);

        if (!user) return <div className="min-h-screen flex items-center justify-center bg-neutral-50 text-neutral-400 font-bold uppercase tracking-widest text-xs">Initializing Flow...</div>;

        return (
            <div className="min-h-screen bg-neutral-50 pb-24 lg:pb-0 selection:bg-neutral-200">

                {/* Desktop Nav */}
                <nav className="sticky top-0 z-50 w-full border-b border-neutral-100 bg-white/80 backdrop-blur-md hidden lg:block">
                    <div className="max-w-6xl mx-auto px-8 h-20 flex items-center justify-between">
                        <div className="flex items-center gap-3">
                            <div className="w-10 h-10 bg-neutral-900 rounded-xl flex items-center justify-center text-white shadow-lg shadow-neutral-200">
                                <Icons.Zap className="w-5 h-5 fill-white" />
                            </div>
                            <span className="font-extrabold text-xl text-neutral-900 tracking-tighter">FocusFlow</span>
                        </div>
                        <div className="flex items-center gap-2">
                            {menuItems.map(item => (
                                <button
                                    key={item.id}
                                    onClick={() => setActiveTab(item.id)}
                                    className={`px-5 py-2 rounded-full text-sm font-bold transition-all ${activeTab === item.id ? 'bg-neutral-900 text-white shadow-md' : 'text-neutral-400 hover:text-neutral-900'}`}
                                >
                                    {item.label}
                                </button>
                            ))}
                        </div>
                        <div className="flex items-center gap-4">
                            <div className="flex items-center gap-2 px-4 py-2 bg-amber-50 rounded-2xl border border-amber-100 shadow-sm">
                                <Icons.Zap className="w-4 h-4 text-amber-500 fill-amber-500" />
                                <span className="text-sm font-black text-amber-700">{totalXP} XP</span>
                            </div>
                            <div className="w-10 h-10 rounded-2xl bg-white border border-neutral-100 flex items-center justify-center text-neutral-400 shadow-sm">
                                <Icons.Bell className="w-5 h-5" />
                            </div>
                        </div>
                    </div>
                </nav>

                <main className="max-w-2xl mx-auto px-6 py-10">
                    <AnimatePresence mode="wait">
                        {(activeTab === 'home' || activeTab === 'tasks') ? (
                            <motion.div key="tasks" initial={{ opacity: 0 }} animate={{ opacity: 1 }} exit={{ opacity: 0 }}>
                                <div className="flex items-end justify-between mb-10">
                                    <div>
                                        <h1 className="text-4xl font-black text-neutral-900 tracking-tight">Focus Flow</h1>
                                        <p className="text-neutral-400 font-bold text-sm mt-1 uppercase tracking-widest">{tasks.filter(t => t.status === 'pending').length} sessions remaining</p>
                                    </div>
                                    <button onClick={() => { setEditingTask(null); setShowForm(true); }} className="w-14 h-14 bg-neutral-900 text-white rounded-2xl shadow-xl shadow-neutral-200 flex items-center justify-center hover:scale-105 active:scale-95 transition-all">
                                        <Icons.Plus className="w-7 h-7" />
                                    </button>
                                </div>

                                {(showForm || editingTask) && (
                                    <TaskForm task={editingTask} onSave={handleSave} onCancel={() => { setShowForm(false); setEditingTask(null); }} />
                                )}

                                <div className="space-y-10">
                                    {groupedTasks.length > 0 ? groupedTasks.map(group => (
                                        <div key={group.date}>
                                            <h3 className="text-[11px] font-black text-neutral-300 uppercase tracking-[0.2em] mb-4 ml-1 flex items-center gap-2">
                                                <Icons.Calendar className="w-3.5 h-3.5" /> {group.date}
                                            </h3>
                                            <div className="space-y-3">
                                                <AnimatePresence mode="popLayout">
                                                    {group.items.map(task => (
                                                        <TaskCard key={task.id} task={task} onComplete={toggleStatus} onEdit={setEditingTask} onDelete={setDeleteConf} />
                                                    ))}
                                                </AnimatePresence>
                                            </div>
                                        </div>
                                    )) : (
                                        <div className="py-24 text-center border-2 border-dashed border-neutral-100 rounded-[2.5rem]">
                                            <Icons.CheckCircle2 className="w-12 h-12 text-neutral-200 mx-auto mb-4" />
                                            <p className="text-neutral-300 font-bold uppercase tracking-widest text-xs">No active sessions</p>
                                        </div>
                                    )}
                                </div>
                            </motion.div>
                        ) : (
                            <PlaceholderView
                                key={activeTab}
                                title={menuItems.find(m => m.id === activeTab).label}
                                description={`Unlock advanced ${activeTab} tracking as you gain more focus XP.`}
                                icon={menuItems.find(m => m.id === activeTab).icon}
                            />
                        )}
                    </AnimatePresence>
                </main>

                {/* Mobile Nav */}
                <div className="fixed bottom-0 left-0 right-0 z-50 bg-white/90 backdrop-blur-xl border-t border-neutral-100 px-2 py-4 lg:hidden">
                    <div className="flex items-center justify-around max-w-md mx-auto">
                        {menuItems.map(item => (
                            <button key={item.id} onClick={() => setActiveTab(item.id)} className={`flex flex-col items-center gap-1.5 px-3 py-1 rounded-2xl transition-all ${activeTab === item.id ? 'text-neutral-900 scale-110' : 'text-neutral-300'}`}>
                                <item.icon className="w-6 h-6" />
                                <span className="text-[9px] font-black uppercase tracking-tighter">{item.label}</span>
                            </button>
                        ))}
                    </div>
                </div>

                {/* Delete Dialog */}
                <AnimatePresence>
                    {deleteConf && (
                        <div className="fixed inset-0 z-[100] flex items-center justify-center p-6 bg-neutral-900/40 backdrop-blur-sm">
                            <motion.div initial={{ opacity: 0, scale: 0.9 }} animate={{ opacity: 1, scale: 1 }} exit={{ opacity: 0, scale: 0.9 }} className="bg-white rounded-[2.5rem] p-8 max-w-sm w-full shadow-2xl">
                                <div className="w-16 h-16 bg-red-50 text-red-500 rounded-3xl flex items-center justify-center mb-6">
                                    <Icons.Trash2 className="w-8 h-8" />
                                </div>
                                <h2 className="text-2xl font-black mb-2">Delete Focus?</h2>
                                <p className="text-neutral-500 font-medium mb-8 leading-relaxed">This session and its XP gains will be permanently erased from your history.</p>
                                <div className="flex gap-3">
                                    <button onClick={() => setDeleteConf(null)} className="flex-1 py-4 border border-neutral-200 rounded-2xl font-bold hover:bg-neutral-50">Keep</button>
                                    <button onClick={deleteTask} className="flex-1 py-4 bg-red-500 text-white rounded-2xl font-bold hover:bg-red-600 shadow-lg shadow-red-100">Delete</button>
                                </div>
                            </motion.div>
                        </div>
                    )}
                </AnimatePresence>
            </div>
        );
    };

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
</script>
</body>
</html>